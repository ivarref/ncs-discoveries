<!DOCTYPE html>
<meta charset="utf-8">
<style>
body { font: 12px sans-serif; }
svg { border: 1px solid #000; }
path { fill: none; stroke: black; stroke-width: 3px; }
text.heading { font: 22px sans-serif; font-variant: small-caps; font-weight: bold; }
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
  shape-rendering: crispEdges;
}
</style>
<title>When was the Petroleum on the Norwegian Continental Shelf discovered?</title>
<body>
<script src="d3.v3.min.js"></script>
<script>
function singleElement(root, elementtype, id) {
  var sel = root.selectAll(elementtype + "#" + id).data([1])
  sel.enter().append(elementtype).attr('id', id)
  return sel
}

var margin = {top: 35, right: 60, bottom: 35, left: 60},
    width = 960 - margin.left - margin.right,
    height = 470 - margin.top - margin.bottom

var svg1 = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

d3.select('body').append('div')

var svg2 = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("margin-top", "1em")
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

function prop(p) { return function(d) { return d[p] } }

function get_cumulative_produced(data) {
  data.forEach(function(d) { 
    d.prfYear = +d.prfYear
    d.prfPrdOilNetMillSm = +d.prfPrdOilNetMillSm
    d.prfPrdGasNetBillSm = +d.prfPrdGasNetBillSm
  })

  data.sort(function(a, b) { return a.prfYear - b.prfYear })

  var cumulative_production = {}

  data.forEach(function(d, i) {
    var values = data.filter(function(d, ii) { return ii <= i })
    cumulative_production[d.prfYear] = {
        'oil' : d3.sum(values, prop('prfPrdOilNetMillSm')) * 6.29 / 1000.0,
        'gas' : d3.sum(values, prop('prfPrdGasNetBillSm')) * 6.29 / 1000.0,
    }
  })

  return function(year) {
    return (year in cumulative_production) ?  cumulative_production[year] : { 'oil' : 0.0, 'gas' : 0.0 }
  }
}

function update(svg, nested_data, resource, colors) {
  var y = d3.scale.linear().range([height, 0])
  var x = d3.scale.ordinal().rangeBands([0, width], .1)

  var resource_capitalized = resource.charAt(0).toUpperCase() + resource.substring(1)

  var idx = nested_data.length-1
  var recoverable_resource = 'cumulative_recoverable_' + resource
  var produced_resource = 'cumulative_produced_' + resource

  x.domain(nested_data.map(function(d) { return d.key }))
  y.domain([0, nested_data[idx][recoverable_resource]])

  var y2 = d3.scale.linear().range([height, 0])
  y2.domain([0, 100])

  svg.selectAll('line').data(d3.range(10, 110, 10))
  .enter()
  .append('line')
  .attr('class', 'axis')
  .attr('x1', 0)
  .attr('x2', width)
  .attr('y1', y2)
  .attr('y2', y2)
  .style('stroke', 'gray')
  .style('stroke-opacity', '60%')

  var xAxis = d3.svg.axis().scale(x).orient("bottom")
  .tickFormat(function(d) { return d })
  .tickValues(x.domain().filter(function(d, i) { return i == 0 || i == x.domain().length-1 || parseInt(d) % 5 == 0 }))

  singleElement(svg, 'g', 'xAxis')
  .attr('class', 'x axis')
  .attr("transform", "translate(0," + height + ")")
  .call(xAxis)
  .selectAll('text')
  .filter(function(d) { return parseInt(d) % 5 != 0 })
  .style('font-style', 'italic')

  singleElement(svg, 'g', 'yAxis2')
  .attr('class', 'y axis')
  .attr("transform", "translate(0,0)")
  .call(d3.svg.axis().scale(y2).orient("left"))

  singleElement(svg, 'g', 'yAxis')
  .attr('class', 'y axis')
  .attr("transform", "translate(" + width + ",0)")
  .call(d3.svg.axis().scale(y).orient("right"))

  /* 
  Goals: 
  ======
  Differentiate recoverable by field status (producing, PDO-approved, planning and likely)
  Show all petroleum
  Add info box with numbers for most recent year

  Done
  ====
  Colors by resource type
  Show gas
  Show remaining values (stronger color)
  Use bars.
  */

  // Total recoverable resources
  singleElement(svg, 'g', 'bars1')
  .selectAll('rect').data(nested_data)
  .enter()
  .append('rect')
  .attr('height', function(d) { return height - y(d[recoverable_resource]) } )
  .attr('width', x.rangeBand())
  .attr('x', function(d, i) { return x(d.key) })
  .attr('y', function(d) { return y(d[recoverable_resource]) })
  .style('fill', colors['remaining']) 

  // Produced recoverable resources
  singleElement(svg, 'g', 'bars2')
  .selectAll('rect').data(nested_data)
  .enter()
  .append('rect')
  .attr('height', function(d) { return height - y(d[produced_resource]) } )
  .attr('width', x.rangeBand())
  .attr('x', function(d, i) { return x(d.key) })
  .attr('y', function(d) { return y(d[produced_resource]) })
  .style('fill', colors['produced'])

  function ww(elm) { return elm.node().getBBox().width }

  var heading1 = singleElement(svg, 'text', 'heading1')
  .attr("transform", "translate(" + (0) + "," + (0) + ")")
  .attr("dy", "-.29em").attr("class", "heading")
  .html('When was the&nbsp;')

  var heading2 = singleElement(svg, 'text', 'heading2')
  .attr("transform", "translate(" + ww(heading1) + "," + (0) + ")")
  .attr("dy", "-.29em").attr("class", "heading")
  .style('fill', colors['remaining'])
  .style('font-weight', '900')
  .html(resource_capitalized + "&nbsp;")

  var heading3 = singleElement(svg, 'text', 'heading3')
  .attr("transform", "translate(" + (ww(heading1) + ww(heading2)) + "," + (0) + ")")
  .attr("dy", "-.29em").attr("class", "heading")
  .text('on the Norwegian Continental Shelf discovered?')

  /*
  var info1 = singleElement(svg, 'text', 'info1')
  .attr("transform", "translate(" + (0) + "," + (0) + ")")
  .attr("dy", ".95em").attr("dx", ".25em").style('font-style', 'italic')
  .html('And when was the ' + resource_capitalized + '&nbsp;')

  var info2 = singleElement(svg, 'text', 'info2')
  .attr("transform", "translate(" + (ww(info1)) + "," + (0) + ")")
  .attr("dy", ".95em").attr("dx", ".25em").style('font-style', 'italic')
  .style('fill', colors['produced'])
  .style('font-weight', 'bold')
  .text('produced')

  var info3 = singleElement(svg, 'text', 'info3')
  .attr("transform", "translate(" + (ww(info1) + ww(info2)) + "," + (0) + ")")
  .attr("dy", ".95em").attr("dx", ".25em").style('font-style', 'italic')
  .text('?')
  */

  singleElement(svg, 'text', 'yaxislabel')
  .attr("transform", "translate(" + (width+35) + "," + (height/2) + ") rotate(90)")
  .attr("dy", "-.29em")
  .attr('text-anchor', 'middle')
  .style('font-variant', 'small-caps')
  .text('Cumulative Discoveries of ' + resource_capitalized + ' in Giga (Billion) Barrels, Gb')

  singleElement(svg, 'text', 'yaxislabel2')
  .attr("transform", "translate(" + (-35) + "," + (height/2) + ") rotate(-90)")
  .attr("dy", ".29em")
  .attr('text-anchor', 'middle')
  .style('font-variant', 'small-caps')
  .text('Percentage of Cumulative Discoveries')


  singleElement(svg, 'text', 'xaxislabel')
  .attr("transform", "translate(" + (width/2) + "," + (height + margin.bottom) + ")")
  .attr("dy", "-.29em")
  .style("text-anchor", "middle")
  .style("font-variant", "small-caps")
  .text('Year of Discovery')

  singleElement(svg, 'text', 'contact')
  .attr("transform", "translate(" + (width + margin.right) + "," + (height + margin.bottom) + ")")
  .attr("dy", "-.29em")
  .attr("dx", "-.29em")
  .style("text-anchor", "end")
  .style('font-variant', 'small-caps')
  .text('Diagram by Refsdal.Ivar@gmail.com')
}

d3.tsv('data/data.tsv', function(err, data) { 
d3.csv('data/produced.csv', function(err, data_production) {

  var cumulative_production = get_cumulative_produced(data_production)

  data.forEach(function(d) {
    d.discovery_year = +d.discovery_year
    d.recoverable_oil = +d.recoverable_oil * 6.29 / 1000.0
    d.recoverable_gas = +d.recoverable_gas * 6.29 / 1000.0

    d.produced_oil = +d.produced_oil * 6.29 / 1000.0
    d.produced_gas = +d.produced_gas * 6.29 / 1000.0
  })

  var nested_data = d3.nest()
  .key(function(d) { return d.discovery_year })
  .sortKeys(d3.ascending)
  .entries(data)

  nested_data.forEach(function(d, i) {

    d.recoverable_oil = d3.sum(d.values, prop('recoverable_oil'))
    d.recoverable_gas = d3.sum(d.values, prop('recoverable_gas'))

    d.cumulative_recoverable_oil = d3.sum(nested_data.filter(function(dd, ii) { return ii <= i }), prop('recoverable_oil'))
    d.cumulative_recoverable_gas = d3.sum(nested_data.filter(function(dd, ii) { return ii <= i }), prop('recoverable_gas'))

    d.cumulative_produced_oil = cumulative_production(parseInt(d.key)).oil
    d.cumulative_produced_gas = cumulative_production(parseInt(d.key)).gas
  })


  var col_oil = { 'remaining' : '#187418', 'produced' : '#5DD45D' /*d3.rgb(152,223,138)*/ }
  var col_gas = { 'remaining' : d3.rgb(254,24,24), 'produced' : d3.rgb(255,152,150) }
  update(svg1, nested_data, 'oil', col_oil)
  update(svg2, nested_data, 'gas', col_gas)

}) })

</script>
</body>
